/*
    Generated by FlexRule JavaScript Compiler at: 12/05/2017 2:00:31 PM
    FlexRule Runtime : 7.0.154
    FlexRule Designer: 0.0.0
*/

var FlexRule=FlexRule||{};
(function(context){var applicationsRuleSets={};FlexRule.Utilities=FlexRule.Utilities||{};FlexRule.Utilities.createNamespace=function(namespace){var nsparts=namespace.split(".");var parent=FlexRule;if(nsparts[0]==="FlexRule")nsparts=nsparts.slice(1);for(var i=0;i<nsparts.length;i++){var partname=nsparts[i];if(typeof parent[partname]==="undefined")parent[partname]={};parent=parent[partname]}return parent};FlexRule.ApplicationsLogic=FlexRule.ApplicationsLogic||{};FlexRule.ApplicationsLogic.register=function(namespace,
logicName,logic){if(namespace==null)throw new Error("namespace is required");if(logicName==null)throw new Error("logicName is required");if(logic==null)throw new Error("fnRule is required");var appName=namespace;var rules=applicationsRuleSets;if(rules[appName]==undefined)rules[appName]={};rules[appName].rules=rules[appName].rules||{};var rs=rules[appName].rules[logicName];if(rs==undefined)rules[appName].rules[logicName]=logic;else throw new Error("Application "+appName+" has already registered the logic name: "+
logicName);};var MonadsFactory=function(){function ResultCollection(){this.Count=0;this.add=function(obj){this.push(obj);this.Count++}}ResultCollection.prototype=Array.prototype;var $where=function(){var local=arguments[0];var predicate=arguments[1];var fn=new Function(local,"return "+predicate);var source=this;var filtered=source.filter(fn);var res=new ResultCollection;for(var i=0;i<filtered.length;i++)res.add(filtered[i]);return res};var $any=function(){var source=this;if(arguments.length==0)return source.length>
0;if(arguments.length!=2)throw Error("$any with parameters requires local and predicate");var local=arguments[0];var predicate=arguments[1];var fn=new Function(local,"return ("+predicate+")==true");for(var index=0;index<source.length;index++)if(fn(source[index]))return true;return false};var $all=function(){var source=this;if(arguments.length!=2)throw Error("$all requires local and predicate");var local=arguments[0];var predicate=arguments[1];var fn=new Function(local,"return ("+predicate+")==true");
for(var index=0;index<source.length;index++)if(!fn(source[index]))return false;return true};var $groupBy=function(){if(arguments.length!=2)throw Error("$groupBy requires local and predicate");function MonadGrouping(key){this.Count=0;this.add=function(obj){this.push(obj);this.Count++};this.Key=key}MonadGrouping.prototype=Array.prototype;var source=this;var local=arguments[0];var fnKeys=[];for(var i=1;i<arguments.length;i++){var fnKey=new Function(local,"return "+arguments[i]);fnKeys.push({fn:fnKey,
name:arguments[i].substring(local.length+1)})}var result=[];var buildKey=function(obj){var key={};for(var k=0;k<fnKeys.length;k++){var n=fnKeys[k].name;key[n]=fnKeys[k].fn(obj)}return key};var exists=function(array,key){var kj=JSON.stringify(key);for(var i=0;i<array.length;i++)if(kj===JSON.stringify(array[i].Key))return array[i];return null};for(var index=0;index<source.length;index++){var key=buildKey(source[index]);var found=exists(result,key);if(found==null){found=new MonadGrouping(key);result.push(found)}found.add(source[index])}return result};
var $select=function(){if(arguments.length!=2)throw Error("$select requires local and predicate");var source=this;var local=arguments[0];var predicate=arguments[1];var fnKey=new Function(local,"return "+predicate);var result=new ResultCollection;for(var index=0;index<source.length;index++){var value=fnKey(source[index]);result.add(value)}return result};var $count=function(){if(arguments.length==0)return this.length;if(arguments.length!=2)throw Error("$count requires local and predicate");var source=
this;var local=arguments[0];var predicate=arguments[1];var f=$where.call(source,local,predicate);return f.length};function isArray(obj){return!!obj&&obj.constructor===Array}var $skip=function(){if(!isArray(this))return null;if(arguments.length==0)throw Error("$skip requires count numeric number");var cnt=parseInt(arguments[0]);var res=new ResultCollection;var source=this;for(var i=cnt;i<source.length;i++)res.add(source[i]);return res};var $add=function(){if(!isArray(this))throw Error("$add requires array");
var a=this;a.push(arguments[0]);return a};var $removeAt=function(){if(!isArray(this))throw Error("$remove requires array");var a=this;var index=parseInt(arguments[0]);if(index>-1)a.splice(index,1);return a};var $remove=function(){if(!isArray(this))throw Error("$remove requires array");var a=this;var index=array.indexOf(arguments[0]);if(index>-1)a.splice(index,1);return a};var $take=function(){if(!isArray(this))return null;if(arguments.length==0)throw Error("$take requires count numeric number");var cnt=
parseInt(arguments[0]);var res=new ResultCollection;var source=this;for(var i=0;i<source.length&&i<cnt;i++)res.add(source[i]);return res};var $first=function(){if(!isArray(this))return null;if(this.length==0)return null;if(arguments.length==0)return this[0];if(arguments.length!=2)throw Error("$first requires local and predicate");var local=arguments[0];var predicate=arguments[1];var fn=new Function(local,"return "+predicate);var source=this;for(var i=0;i<source.length;i++)if(fn(source[i]))return source[i];
return null};var $last=function(){if(!isArray(this))return null;if(this.length==0)return null;if(arguments.length==0)return this[this.length-1];if(arguments.length!=2)throw Error("$last requires local and predicate");var local=arguments[0];var predicate=arguments[1];var fn=new Function(local,"return "+predicate);var source=this;for(var i=source.length-1;i>=0;i--)if(fn(source[i]))return source[i];return null};return{$where:$where,$filter:$where,$any:$any,$exists:$any,$all:$all,$groupBy:$groupBy,$select:$select,
$count:$count,$length:$count,$first:$first,$firstOrDefault:$first,$last:$last,$lastOrDefault:$last,$skip:$skip,$take:$take,$add:$add,$remove:$remove,$removeAt:$removeAt}};function registerMonads(){var monad=new MonadsFactory;Array.prototype.$fr$monad$where=monad.$where;Array.prototype.$fr$monad$filter=monad.$filter;Array.prototype.$fr$monad$any=monad.$any;Array.prototype.$fr$monad$all=monad.$all;Array.prototype.$fr$monad$exists=monad.$exists;Array.prototype.$fr$monad$groupBy=monad.$groupBy;Array.prototype.$fr$monad$select=
monad.$select;Array.prototype.$fr$monad$count=monad.$count;Array.prototype.$fr$monad$length=monad.$length;Array.prototype.$fr$monad$first=monad.$first;Array.prototype.$fr$monad$firstOrDefault=monad.$firstOrDefault;Array.prototype.$fr$monad$last=monad.$last;Array.prototype.$fr$monad$lastOrDefault=monad.$lastOrDefault;Array.prototype.$fr$monad$skip=monad.$skip;Array.prototype.$fr$monad$take=monad.$take;Array.prototype.$fr$monad$add=monad.$add;Array.prototype.$fr$monad$removeAt=monad.$removeAt;Array.prototype.$fr$monad$remove=
monad.$remove}registerMonads();var CustomFunctions=function(){var fns=[];this.register=function(name,fn){if(name==null||name==undefined)throw Error("name of function is required");if(typeof fn!="function")throw Error("function is required");fns.push({name:name,func:fn})};this.run=function(){var self=arguments[0];var name=arguments[1];if(typeof name!="string")throw Error("function name is required.");var found=fns.filter(function(x){return x.name==name});if(found!=null&&found.length>0){var logic=found[0];
var args=[];for(var i=2;i<arguments.length;i++)args.push(arguments[i]);var res=logic.func.apply(self,args);return res}else throw Error("Could not find custom function: "+name);}};var _customFunctions=new CustomFunctions;var Engine=function(){var Context=function(){var Notification=function(group){var notices=[];var group=group;var addNotice=function(type,message,tag){notices.push({type:type,message:message,tag:tag!=undefined?tag:null})};return{addError:function(message,tag){addNotice("Error",message,
tag)},addInfo:function(message,tag){addNotice("Info",message,tag)},addWarning:function(message,tag){addNotice("Warning",message,tag)},notices:notices,group:group}};var NotificationSet=function(){var defaultNotification=new Notification(null);var notifications=[];return{"default":defaultNotification,getNotification:function(name){if(name==null||name==undefined)return defaultNotification;for(var i=0;i<notifications.length;i++)if(notifications[i].group==name)return notifications[i];return defaultNotification}}};
this.notifications=new NotificationSet};var engineContext=new Context;var getContext=function(result){var list=result.outputs;var ctx={context:engineContext};ctx.context.variableContainer={};if(list!=null)for(var i=0;i<list.length;i++)ctx.context.variableContainer[list[i].name]=list[i].value;return ctx};var Descriptions=function(namespace,logicName,logics,parameters){this.logics=logics;this.logicName=logicName;this.appNamespace=namespace;this.parameters=parameters};var getDescriptions=function(logics,
parameters){return new Descriptions(null,null,logics,parameters.map(function(c){return{name:c.name,direction:c.direction}}))};var Logic=function(name,fnCondition,fnThen,fnOtherwise){this.name=name;this.fnCondition=fnCondition;this.fnThen=fnThen;this.fnOtherwise=fnOtherwise};var CalDate=function(){function advanceByMillies(date,millies){var futureMillies=date.getTime()+millies;return new Date(futureMillies)}function advanceByHours(date,hours){return advanceByMillies(date,60*60*1E3*hours)}function advanceByMinutes(date,
minutes){return advanceByMillies(date,60*1E3*minutes)}function advanceBySeconds(date,seconds){return advanceByMillies(date,1E3*second)}function advanceByDays(date,days){var millies=1E3*60*60*24*days;return advanceByMillies(date,millies)}function advanceByYears(date,years){var next=date.getFullYear()+1;var days=getDays(next);return advanceByDays(date,days)}function advanceByMonths(date,months){var newDate=new Date(date.getTime());var days=0;var i=0;while(i<months){days=daysInThisMonth(newDate);newDate=
advanceByDays(newDate,days);i++}return newDate}function advanceToEndOfMonth(date){var newDate=new Date(date.getTime());var newDay=daysInThisMonth(date);newDate.setDate(newDay);return newDate}function daysInThisMonth(date){var calendarMap={0:31,1:28,2:31,3:30,4:31,5:30,6:31,7:31,8:30,9:31,10:30,11:31};var month=date.getMonth();var days=calendarMap[month];if(month=="1"&&isLeapYear(date.getFullYear()))days++;return days}function isLeapYear(year){return year%4==0&&!(year%100==0)||year%400==0}function getDays(year){if(isLeapYear(year))return 366;
return 365}var getMonth=function(d){return d.getUTCMonth()+1};function diffDate(interval,date1,date2){if(Object.prototype.toString.call(date1)!=="[object Date]"||Object.prototype.toString.call(date2)!=="[object Date]")throw Error("Both date1 and date2 must be Date.");var res=0;switch(interval.toLowerCase()){case "years":var a=(date1.getUTCFullYear()*100+getMonth(date1))*100+date1.getUTCDate();var b=(date2.getUTCFullYear()*100+getMonth(date2))*100+date2.getUTCDate();res=(a-b)/1E4;break;case "months":var a=
(getMonth(date1)-getMonth(date2)+12*(date1.getUTCFullYear()*100-date2.getUTCFullYear()*100))*100+(date1.getUTCDate()-date2.getUTCDate());res=a/1E4;break;case "weeks":res=date1-date2;res=res/(1E3*7*24*60*60);break;case "days":res=date1-date2;res=res/(1E3*24*60*60);break;case "hours":res=date1-date2;res=res/(1E3*60*60);break;case "minutes":res=date1-date2;res=res/(1E3*60);break;case "seconds":res=date1-date2;res=res/1E3;break;case "milliseconds":res=date1-date2;break;case "offset":var d,h,m,s,ms;ms=
date1-date2;s=ms/1E3;m=s/60;s=s%60;h=m/60;m=m%60;d=h/24;h=h%24;ms=Math.floor(ms%1E3*1E3)/1E3;return[~~d,~~h,~~m,~~s,~~ms];default:throw Error("Invalid interval. Use any of: Years, Months, Weekdays, Days, Hours, Minutes and Seconds.");}return res}function addDate(interval,date,value){if(Object.prototype.toString.call(date)!=="[object Date]")throw Error("date must be a Date.");switch(interval.toLowerCase()){case "years":return advanceByYears(date,value);case "months":return advanceByMonths(date,value);
case "weeks":throw Error("dateAdd cannot be done on the weekly bases.");case "days":return advanceByDays(date,value);case "hours":return advanceByHours(date,value);case "minutes":return advanceByMinutes(date,value);case "milliseconds":return advanceByMillies(date,value);case "offset":throw Error("dateAdd cannot be done on the offset bases.");case "seconds":default:return advanceBySeconds(date,value)}}function getTodayUtc(){var utc_timestamp=getNowUtc();utc_timestamp.setHours(0);utc_timestamp.setMinutes(0);
utc_timestamp.setSeconds(0);utc_timestamp.setMilliseconds(0);return utc_timestamp}function getNowUtc(){var now=new Date;var utc_timestamp=Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate(),now.getUTCHours(),now.getUTCMinutes(),now.getUTCSeconds(),now.getUTCMilliseconds());return utc_timestamp}function getDateUtc(year,month,day,hour,minute,second,milliseconds){var date1=Date.UTC(year,month-1,day,hour,minute,second,milliseconds);return new Date(date1)}return{isLeapYear:isLeapYear,dateDiff:diffDate,
nowUtc:getNowUtc,todayUtc:getTodayUtc,dateUtc:getDateUtc}};var Functions=function(){var _dateUtil=new CalDate;this.array=function(){var r=[];for(var i=0;i<arguments.length;i++)r.push(arguments[i]);return r};this.New=function(){return{}};this.todayUtc=_dateUtil.todayUtc;this.nowUtc=_dateUtil.nowUtc;this.dateUtc=_dateUtil.dateUtc;this.dateAdd=_dateUtil.dateAdd;this.dateDiff=_dateUtil.dateDiff;this.round=function(value,precision){var index=value.toString().indexOf(".");if(index==-1)return value;if(value<
0)index=index-1;var res=value.toPrecision(index+precision);return Number(res)}};var validate=function(validation,name,args){var found=validation.filter(function(x){return x.name==name});if(found!=null&&found.length>0){var logic=found[0];var self=this;var res=logic.fnCondition.apply(self,args);res=validationEngine.getResult(res,args);if(res==true||res==undefined){res=true;if(logic.fnThen)logic.fnThen.apply(self,args)}else if(logic.fnOtherwise)logic.fnOtherwise.apply(self,args);return res}else throw Error("Could not find validation's logic: "+
name);};var compare=function(left,op,right){if(op=="is")return left==right;else if(op=="is not")return left!=right;else{if(left==null)left="";var res=left.match(new RegExp(right));res=res!=null&&res.length>0;if(op=="match")return res;else return!res}};var compute=function(expression,container){if(typeof expression==="string"||expression instanceof String){if(expression.indexOf(".")==-1){if(expression=="")return expression;return container==null||container==undefined?eval(expression):container[expression]}var properties=
expression.split(".");var current=null;for(var i=0;i<properties.length;i++)if(i==0)if(container==null||container==undefined)current=eval(properties[i]);else current=container[properties[i]];else current=current[properties[i]];return current}return expression};function MessageFormatter(){var reg=new RegExp("({+)(.*?)(}+)","g");var format=function(message,container){if(message==null||message==undefined)message="";var matches=getMatches(message);var msg=message;for(var i=0;i<matches.length;i++){var m=
matches[i];var val=compute(m.eval,container);msg=replace(msg,m.index,m.expression,val);var diff=m.expression.length-val.length;updateRest(i+1,matches,diff)}return msg};function updateRest(index,matches,difference){for(var i=index;i<matches.length;i++)matches[i].index=matches[i].index-difference}function getMatches(message){var matches=[];var match;while((match=reg.exec(message))!=null)matches.push({expression:match[0],eval:match[2],index:match.index});return matches}function replace(msg,index,oldValue,
newValue){if(newValue==null||newValue==undefined)newValue="";if(index>=msg.length||index<0)return msg;var s=msg.slice(0,index)+msg.slice(index).replace(oldValue,newValue);return s}return{format:format}}var formatter=new MessageFormatter;var Group=function(list){this.items=[];this.config=list[0];for(var i=1;i<list.length;i++)this.items.push(list[i]);this.getListOps=function(){var ops=[];for(var i=0;i<this.items.length;i++)if(i%2==1)ops.push(this.items[i]);return ops}};var ValidationEngine=function(){function getType(item){if(item instanceof
Group)return"group";else if(typeof item=="function")return"function";return"operator"}function getResult(item,args){var type=getType(item);if(type=="group")return runGroup(item,args);else if(type=="function"){var r=item.apply(null,args);return r}return item}var runGroup=function(group,args){if(group==null||group==undefined||getType(group)!="group"){Error("group is required");return}var current=group.items.length>0?group.items[0]:null;if(current==null)throw"Could not find any item in the group";var listOps=
group.getListOps();var currentResult=getResult(current,args);var list=new BitwiseList;list.rest();var processAll=group.config.processAll==undefined?false:group.config.processAll;var exist=false;for(var i=1;i<group.items.length;i++){var operation=group.items[i];var type=getType(operation);if(type!="operator")throw"Boolean is operator (i.e. and, or, nor, xor, xnor) expected.";var rightHand=i+1<group.items.length?group.items[i+1]:null;if(rightHand==null)return false;else i++;var rightResult=null;switch(operation.toLowerCase()){case "and":list.addAnd(currentResult);
if(listOps.length==1&&!list.result&&!processAll){exist=true;break}if(list.length>0&&!list.result&&!processAll){exist=true;break}rightResult=getResult(rightHand,args);if(typeof rightResult!="boolean")continue;list.addAnd(rightResult);break;case "or":list.addOr(currentResult);if(listOps.length==1&&list.result&&!processAll){exist=true;break}if(list.length>0&&list.result&&!processAll){exist=true;break}rightResult=getResult(rightHand,args);if(typeof rightResult!="boolean")continue;list.addOr(rightResult);
break;case "nor":list.addNor(currentResult);rightResult=getResult(rightHand,args);if(typeof rightResult!="boolean")continue;list.addNor(rightResult);break;case "xor":list.addXor(currentResult);rightResult=getResult(rightHand,args);if(typeof rightResult!="boolean")continue;list.addXor(rightResult);break;case "xnor":list.addXnor(currentResult);rightResult=getResult(rightHand,args);if(typeof rightResult!="boolean")continue;list.addXnor(rightResult);break}currentResult=list.result;if(exist)break}return currentResult==
1?true:false};BitwiseList=function(){var list=[];this.result=null;this.rest=function(){list=[];this.result=null};this.addAnd=function(bit){list.push(bit);if(this.result==null)this.result=bit;else this.result=this.result&bit};this.addOr=function(bit){list.push(bit);if(this.result==null)this.result=bit;else this.result=this.result|bit};this.addXor=function(bit){list.push(bit);if(this.result==null)this.result=bit;else this.result=this.result^bit};this.addNor=function(bit){list.push(bit);for(var i=0;i<
list.length;i++)if(b){this.result=false;break}};this.addXnor=function(bit){list.push(bit);var first=list[0];for(var i=0;i<list.length;i++)if(b!=first){this.result=false;break}}};return{getResult:getResult}};var validationEngine=new ValidationEngine;var getExecutionContext=function(executor){engineContext=new Context;var exec=executor;var localValues=[];var writeError=function(){var group=arguments[0];var msg=arguments[1];var sig=exec.getSignature();localValues.forEach(function(x){sig[x.name]=x.value});
var message=formatter.format(msg,sig);var notificationSet=engineContext.notifications.getNotification(group);notificationSet.addError(message)};var writeInfo=function(){var group=arguments[0];var msg=arguments[1];var sig=exec.getSignature();var message=formatter.format(msg,sig);var notificationSet=engineContext.notifications.getNotification(group);notificationSet.addInfo(message)};var writeWarning=function(){var group=arguments[0];var msg=arguments[1];var sig=exec.getSignature();var message=formatter.format(msg,
sig);var notificationSet=engineContext.notifications.getNotification(group);notificationSet.addWarning(message)};var defineLocal=function(name,value){localValues.push({name:name,value:value})};return{defineLocal:defineLocal,WriteInfo:writeInfo,WriteInformation:writeInfo,WriteError:writeError,WriteWarning:writeWarning}};return{getExecutionContext:getExecutionContext,getContext:getContext,getDescriptions:getDescriptions,validate:validate,functions:new Functions,customFunctions:_customFunctions,compute:compute,
compare:compare,createLogic:function(name,fnCondition,fnThen,fnOtherwise){return new Logic(name,fnCondition,fnThen,fnOtherwise)},createGroup:function(){return new Group(arguments)}}};var runtime=FlexRule.Utilities.createNamespace("FlexRule.RuntimeEngine");runtime.fromJavaScript=function(appNamespace,logicName){if(applicationsRuleSets[appNamespace]==undefined)throw Error("Invalid application namespace: "+appNamespace);if(applicationsRuleSets[appNamespace].rules[logicName]==undefined)throw Error("Invalid application logic name: "+
logicName);var js=new applicationsRuleSets[appNamespace].rules[logicName];js.engine=new Engine;js.registerFunction=_customFunctions.register;js.descriptions=js.getDescriptions();js.descriptions.logicName=logicName;js.descriptions.appNamespace=appNamespace;delete js.getDescriptions;return js}})(FlexRule);
