(function(me,$){$.fn.toNaturalLanguage=function(options){var editor=CodeMirror.fromTextArea(this.get(0),{lineNumbers:true,styleActiveLine:true,lineNumbers:true,lineWrapping:true,scrollbarStyle:"simple",extraKeys:{"Ctrl-Space":"autocomplete"},mode:{name:"FlexRule-NaturalLanguage",glossary:FlexRule.Editor.Glossary}});var nl=new NL(editor);if(options&&options.size&&options.size.width&&options.size.height)nl.setSize(options.size.width,options.size.height);return nl};var NL=function(ed){var editor=ed;
var self=this;var modelBuilder;var orig=CodeMirror.hint.anyword;CodeMirror.hint.anyword=function(cm){var inner=orig(cm)||{from:cm.getCursor(),to:cm.getCursor(),list:[]};var glossary=editor.doc["frGlossary"];if(glossary){inner.list=[];var names=glossary.getAllWhens(true).map(function(x){return x.name});for(var i=0;i<names.length;i++)inner.list.unshift(names[i]);names=glossary.getAllNames();for(var i=0;i<names.length;i++)inner.list.unshift(names[i])}return inner};editor.on("beforeChange",function(instance,
change){var text=instance.getValue();FlexRule.Editor.Glossary.importWhen(text);return true});self.loadGlossary=function(content){var nl=editor.getValue();FlexRule.Editor.Glossary.addNew(content);editor.setValue(nl)};self.clearGlossaries=function(){FlexRule.Editor.Glossary.deleteAll()};self.getGlossaries=function(){if(!modelBuilder)throw"Content has not been loaded yet.";var gl=modelBuilder.Signature.GetGlossaries();return gl.map(function(obj){return obj.Uri})};self.loadNaturalLanguage=function(text){modelBuilder=
(new builder).getModelBuilder(text);var nl=modelBuilder.GetDsl();FlexRule.Editor.Glossary.importWhen(nl);editor.setValue(nl)};self.getName=function(){return modelBuilder.Signature.GetRuleName()};self.setSize=function(width,height){editor.setSize(width,height)};self.getNaturalLanguage=function(){if(!modelBuilder)throw"No model has been loaded yet.";var table={};table.Name=modelBuilder.Signature.GetRuleName();table.Inputs=modelBuilder.Signature.GetInputs();table.Outputs=modelBuilder.Signature.GetOutputs();
table.GlossaryLookup=FlexRule.Editor.Glossary;table.Dsl=editor.getValue();return modelBuilder.GenerateXml(table)};return self};var builder=function(){var ruleModelBuilder=function(source){var $model=$($.parseXML(source)).find("Natural");this.Signature=FlexRule.Editor.getSignatureBuilder($model);this.GenerateXml=function(ruleModel){var xml=FlexRule.Utilities.XML.getConvertor();var dt={Natural:{_name:ruleModel.Name,Declaration:null,Glossary:null,Dsl:null}};this.Signature.Build(dt,"Natural",ruleModel);
function replaceAll(find,replace,str){return str.replace(new RegExp(find,"g"),replace)}var dt2={Natural:{_name:ruleModel.Name,add:[]}};if(ruleModel.ProcessAll)dt2._processAll=ruleModel.ProcessAll;dt2.Natural.add.push({Declaration:dt.Natural.Declaration});dt2.Natural.add.push({Glossary:dt.Natural.Glossary});dt2.Natural.add.push({Dsl:ruleModel.Dsl});var xmlString=xml.json2xml_str(dt2);xmlString=replaceAll("<add>","",xmlString);xmlString=replaceAll("</add>","",xmlString);xmlString=FlexRule.Utilities.XML.UnescapeRuleBody(xmlString);
return xmlString};this.GetProcessAll=function(){var proc=$model.attr("processAll");if(!proc)return true;else return eval(proc.toLowerCase())};this.GetTableType=function(){var type=$model.attr("type");if(!type)return"Validation";else return type};this.GetDsl=function(){var dsl=$model.find("Dsl");return dsl.text()}};this.getModelBuilder=function(source){return new ruleModelBuilder(source)}}})(FlexRule,jQuery);
