(function(me,$){$.fn.toDecisionTable=function(options){var id=this.attr("id");if(!id)throw"DecisionTable must have an id to reference.";else{this.empty();var thead=$("<thead><tr></tr></thead>");this.append(thead);this.append($("<tbody/>"));return new DT(this)}};me.Editor.DecisionTable={};var DT=function(dt){var dtElement=dt;var self=this;var userHandler;var controller;self.signature=null;self.loadDecisionTable=function(content){var mb=new builder;var $scope={};$scope.dtElement=dtElement;$scope.editCell=
function(e){};controller=new ctrl($scope,mb.getModelBuilder(content),mb.getViewBuilder($scope),{},{},{},{});$scope.InitView();controller.BuildTable();self.signature=$scope.updateScope(me.Editor.Glossary);userHandler=$scope;var cell00=$(dtElement).find("td:first");$scope.editCell(cell00[0])};self.clearGlossaries=function(){FlexRule.Editor.Glossary.deleteAll()};self.getColumns=function(){return FlexRule.Utilities.ToLowerProperty(userHandler.table.Columns)};self.updateColumns=function(columns){columns=
FlexRule.Utilities.ToUpperProperty(columns);var newCols=[];var deletedCols=[];for(var i in columns)if(!columns[i].Deleted)newCols.push(table.Columns[i]);else deletedCols.push(i);$scope.table.Columns=newCols;viewBuilder.DeleteColumns(deletedCols);viewBuilder.UpdateColumnHeaders($scope.table.Columns);userHandler.table.Columns=columns};self.createColumnCondition=function(column){if(!column.name)throw"column 'name' is required";return controller.createNewCondition(column)};self.createColumnAction=function(column){if(!column.name)throw"column 'name' is required";
return controller.createNewAction(column)};self.createColumnNotice=function(column){if(!column.name)throw"column 'name' is required";return controller.createNewNotice(column)};self.setName=function(name){userHandler.table.Name=name};self.getTableType=function(){return userHandler.table.Type};self.setTableType=function(type){userHandler.table.Type=type};self.getProcessAll=function(){return userHandler.table.ProcessAll};self.setProcessAll=function(processAll){userHandler.table.ProcessAll=processAll};
self.getName=function(){return userHandler.table.Name};self.addNewRow=function(){userHandler.addNewRow()};self.getGlossaries=function(){return userHandler.getGlossaries()};self.getDecisionTable=function(){return userHandler.getRuleContent()};self.deleteRow=function(){userHandler.deleteRow()};self.deleteColumn=function(reselect){userHandler.deleteColumn(reselect)};self.deleteColumnByIndex=function(columnIndex,reselect){userHandler.deleteColumnByIndex(columnIndex,reselect)};self.loadGlossary=function(content){me.Editor.Glossary.addNew(content)};
return self};var builder=function(){var tableViewBuilder=function(scopeHandler){var currentCell;var tableId=null;function getPreElement(str){return $("<pre >"+str.trim()+"</pre>")}this.CreateNewRow=function(arrayOrCount){if(!arrayOrCount)return undefined;var isArray=$.isArray(arrayOrCount);var count=isArray?arrayOrCount.length:arrayOrCount;var rowSource="<tr />";var row=$(rowSource);row.click(function(e){scopeHandler.editCell(e.target)});for(var i=0;i<count;i++){var td=$("<td />");if(isArray)td.append(getPreElement(arrayOrCount[i]));
else td.append(getPreElement(""));row.append(td)}return row.get(0)};this.PushNewColumn=function(){var rows=$(tableId).find("tbody").children();rows.each(function(){var td=$("<td/>");td.text(" ");$(this).append(td)})};this.UpdateColumnHeaders=function(columns){for(var i in columns){var th=$(tableId).find("thead tr th:eq("+i+")");var label=th.contents().filter(function(){return this.nodeType==Node.TEXT_NODE});if(label.length==1)label[0].data=columns[i].Name}};this.DeleteColumns=function(columns){var list=
[];var addHeadersToDelete=function(){for(var i in columns){var th=$(tableId).find("thead tr th:eq("+columns[i]+")");list.push(th)}};var addDataToDelete=function(){var rowsLength=$(tableId).find("tr").length;var r=0;while(r<rowsLength){for(var i in columns){var index=columns[i];var td=$(tableId).find("tbody tr:eq("+r+") td:eq("+index+")");list.push(td)}r++}};var cleanup=function(){var columnsLength=$(tableId).find("thead tr th").length;if(columnsLength==0)$(tableId).find("tbody").empty()};var deleteColumns=
function(){for(var del in list)$(list[del]).remove()};var c=$(this.GetCurrent());if(c.prop("tagName")!="TD")return null;var row=c.parent();addHeadersToDelete();addDataToDelete();deleteColumns();cleanup();return row};this.ResetTable=function(){$(tableId).find("thead tr").empty();$(tableId).find("tbody").empty()};this.GetRows=function(){var rows=$(tableId).find("tbody tr");var list=[];rows.each(function(){var row={Row:[]};var tds=$(this).find("td");tds.each(function(){var val;var $cell=$(this);if($cell.find("input").length>
0)val=$cell.find("input").val();else val=$($cell.find("pre").get(0)).text();row.Row.push(val)});list.push(row)});return list};this.AppendRow=function(row){if(!row)return;var tbl=$(tableId).find("tbody");tbl.append(row)};this.CreateNewColumn=function(name,cnd){if(!name&&cnd!="Name")return undefined;var thSource='<th class="dt-'+cnd+'" style="width: 150px; vertical-align:top; text-align:center;"><div class="decisionTable column-Draghandle">&nbsp;</div>'+name+"</th>";var th=$(thSource);return th.get(0)};
this.AppendColumn=function(th){if(!th)return;var tr=$(tableId).find("thead tr");tr.append(th)};var sortable,dragable;this.Init=function(id,start,moved){tableId=id;var destroyAll=function(){if(dragable)$(tableId).dragtable("destroy");if(sortable)$(tableId).find("tbody").sortable("destroy")};var enableRowDragging=function(){sortable=$(tableId).find("tbody").sortable({placeholder:"ui-state-highlight",cursor:"move",helper:function(e,tr){if(start)start();var $originals=tr.children();var $helper=tr.clone();
$helper.children().each(function(index){$(this).width($originals.eq(index).width());$(this).addClass("row-DragHandle")});return $helper},stop:function(e,ui){$("tr.td.index",ui.item.parent()).each(function(i){$(this).html(i+1)})}});sortable.disableSelection()};var enableColumnDragging=function(){dragable=$(tableId).dragtable({dragHandle:".column-Draghandle",beforeMoving:function(event,ui){if(start)start(event,ui)},beforeStop:function(event,ui){if(moved){var end=event.endIndex;var start=event.startIndex;
moved(start,end)}}})};destroyAll();enableColumnDragging();enableRowDragging()};var getAvailableCell=function(isNext,current,changeRow){if(!current)return undefined;if(changeRow){var c=$(current);var index=c.index();var tr=!isNext?c.closest("tr").prev():c.closest("tr").next();if(tr.length>0)return tr.children().eq(index).get(0)}else{var pr=!isNext?$(current).prev():$(current).next();if(pr.length>0)return pr.get(0)}return undefined};function editCell(cell,selectEnd,fnHintBody){if(!cell)return null;
var $cell=$(cell);var removeCurrentSelection=function(){if(currentCell){var input=$(currentCell).find("input");$(currentCell).find("i").remove();var text=input.val();input.replaceWith(getPreElement(text));$(currentCell).removeClass("cell-edit")}};var addNewSelection=function(){var style="border: none 0px; padding: 9.5px; margin: 0px; border-collapse: collapse; width:100%; outline: 0; font-family:Menlo,Monaco,Consolas,'Courier New',monospace; font-size:13px;";var div=$('<i data-placement="bottom" data-toggle="popover" class="txt-color-orange fa fa-info-circle decisionTable-cellInfo"></i>');
var hint=fnHintBody!=null?fnHintBody():null;if(hint){var pop=div.popover({html:true,container:"body",content:function(){var res=fnHintBody();return res.content}});pop.on("shown.bs.popover",function(e){var tip=$(this).data("bs.popover").tip();tip.find("select").on("change",function(ev){if(hint)fnHintBody().handler(this.value)})})}style=style+"width: "+$cell.width();var editor=$('<input style="'+style+'" type="text" value="" />');editor.addClass("cell-edit");editor.val($cell.text());$cell.html(editor);
currentCell=cell;if(currentCell&&currentCell.length==0)currentCell=null;$cell.find("input").focus();$cell.addClass("cell-edit");if(selectEnd){var strLength=editor.val().length;editor[0].setSelectionRange(strLength,strLength)}if(hint)$(editor).parent().append(div);return $(div).get(0)};var hookupKeydown=function(){$cell.keydown(function(e){var k=e.keyCode;var p=e.target.selectionStart;var goEnd=false;var availableCell;if(k==37&&p==0){e.preventDefault();availableCell=getAvailableCell(false,cell,false);
goEnd=true}else if(k==38){e.preventDefault();availableCell=getAvailableCell(false,cell,true)}else if(k==39&&p==e.target.value.length){e.preventDefault();availableCell=getAvailableCell(true,cell,false)}else if(k==9){e.preventDefault();availableCell=getAvailableCell(!e.shiftKey,cell,false)}else if(k==40||k==13){e.preventDefault();availableCell=getAvailableCell(true,cell,true)}else if(k==8){var is_chrome=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;if(is_chrome)e.preventDefault()}if(availableCell){$cell.unbind();
editCell(availableCell,goEnd)}})};removeCurrentSelection();var i=addNewSelection();hookupKeydown();return i}this.DeleteRow=function(){var c=$(this.GetCurrent());if(c.prop("tagName")!="TD")return null;var row=c.parent();var select=row.prev();if(select.first())select=row.next();row.remove();return select};this.GetCurrent=function(){return currentCell};this.EditCell=function(cell,selectEnd,fnHintBody){editCell(cell,selectEnd,fnHintBody)};this.EnterValue=function(value){if(!currentCell)return;var input=
$(currentCell).find("input");if(input)input.val(value)}};var tableModelBuilder=function(source){var $model=$($.parseXML(source)).find("DecisionTable");this.GetTableName=function(){return $model.attr("name")};this.Signature=FlexRule.Editor.getSignatureBuilder($model);this.GenerateXml=function(table){var xml=FlexRule.Utilities.XML.getConvertor({useDoubleQuotes:true});var dt={DecisionTable:{_name:table.Name,_processAll:table.ProcessAll,Declaration:null,Glossary:null,Columns:null,Data:null}};if(table.Type!=
"Validation")dt.DecisionTable._type=table.Type;this.Signature.Build(dt,"DecisionTable",table);var columns=$(table.Columns);if(columns.length>0){dt.DecisionTable.Columns={};dt.DecisionTable.Columns.add=[]}$(table.Columns).each(function(){var col=this;if(col.Column=="Condition"){var cond={"Condition":{_name:col.Name}};if(col.Expression)cond.Condition._expression=col.Expression;if(col.Term)cond.Condition._term=col.Term;dt.DecisionTable.Columns.add.push(cond)}else if(col.Column=="Action"){var action=
{"Action":{_name:col.Name}};if(col.Expression)action.Action._expression=col.Expression;if(col.Term)action.Action._term=col.Term;if(col.Type)action.Action._type=col.Type;if(col.Variable)action.Action._variable=col.Variable;if(col.Notice)action.Action._notice=col.Notice;dt.DecisionTable.Columns.add.push(action)}else{var name={"Name":{}};dt.DecisionTable.Columns.add.push(name)}});if(table.Rows.length>0){if(!dt.DecisionTable.Data){dt.DecisionTable.Data={};dt.DecisionTable.Data.Row=[]}$(table.Rows).each(function(){var $r=
$(this);var row={Value:[]};$r.each(function(){row.Value=this.Row});dt.DecisionTable.Data.Row.push(row)})}function replaceAll(find,replace,str){return str.replace(new RegExp(find,"g"),replace)}var dt2={DecisionTable:{_name:table.Name,_processAll:table.ProcessAll,add:[]}};if(dt.DecisionTable.Declaration)dt2.DecisionTable.add.push({Declaration:dt.DecisionTable.Declaration});if(dt.DecisionTable.Glossary)dt2.DecisionTable.add.push({Glossary:dt.DecisionTable.Glossary});dt2.DecisionTable.add.push({Columns:dt.DecisionTable.Columns});
dt2.DecisionTable.add.push({Data:dt.DecisionTable.Data});var xmlString=xml.json2xml_str(dt2);xmlString=replaceAll("<add>","",xmlString);xmlString=replaceAll("</add>","",xmlString);xmlString=FlexRule.Utilities.XML.UnescapeRuleBody(xmlString);return xmlString};this.GetProcessAll=function(){var proc=$model.attr("processAll");if(!proc)return true;else return eval(proc.toLowerCase())};this.GetTableType=function(){var type=$model.attr("type");if(!type)return"Validation";else return type};this.AddNewColumn=
function(column){var dec=$model.find("Declaration");if(column.Column=="Condition")dec.append($('<Condition name="" expression="" />'))};this.GetRows=function(){var rows=$model.find("Data Row");var list=[];if(!rows)return list;for(var i=0;i<rows.length;i++){var $row=$(rows[i]);var $values=$($row.children());var values=[];$values.each(function(){values.push($(this).text())});var row={Values:values};list.push(row)}return list};this.GetColumns=function(){var cols=$model.find("Columns").children();var list=
[];if(!cols)return list;for(var i=0;i<cols.length;i++){var $col=$(cols[i]);var col={Column:$col.prop("tagName"),Name:$col.attr("name"),Expression:$col.attr("expression"),Type:$col.attr("type"),Variable:$col.attr("variable"),Term:$col.attr("term")};if(col.Column=="Name")col.Name="Rule Name";list.push(col)}return list}};this.getModelBuilder=function(source){return new tableModelBuilder(source)};this.getViewBuilder=function(scopeHandler){return new tableViewBuilder(scopeHandler)}};var ctrl=function($scope,
modelB,viewB,$compile,$modal,fileListService,glossaryLookupServer){$scope.table={Name:null,Type:null,ProcessAll:null,Columns:[],Inputs:[],Outputs:[],Rows:[],GlossaryLookup:null};$scope.loadingGlossaries=false;var viewBuilder=viewB;var modelBuilder=modelB;$scope.getRuleContent=function(){$scope.table.Rows=viewBuilder.GetRows();var generatedXml=modelBuilder.GenerateXml($scope.table);return generatedXml};$scope.getGlossaries=function(){var gl=modelBuilder.Signature.GetGlossaries();return gl.map(function(obj){return obj.Uri})};
$scope.deleteColumn=function(reselect){var col=getCurrentColumnIndex();var select=$scope.deleteColumnByIndex(col);viewBuilder.UpdateColumnHeaders($scope.table.Columns);if(reselect&&select)selectfirstCell($(select))};$scope.deleteColumnByIndex=function(index){var col=viewBuilder.DeleteColumns([index]);FlexRule.Utilities.DeleteByIndex($scope.table.Columns,index);viewBuilder.UpdateColumnHeaders($scope.table.Columns);return col};$scope.deleteRow=function(){var select=viewBuilder.DeleteRow();if(select&&
select.first())selectfirstCell(select)};var buildDecisionTableView=function(){var updateColumns=function(){var columns=modelBuilder.GetColumns();for(var i=0;i<columns.length;i++){var col=viewBuilder.CreateNewColumn(columns[i].Name,columns[i].Column);viewBuilder.AppendColumn(col)}};var updateDataRows=function(){var rows=modelBuilder.GetRows();var firstRow=undefined;for(var i=0;i<rows.length;i++){var newRow=viewBuilder.CreateNewRow(rows[i].Values);viewBuilder.AppendRow(newRow);if(!firstRow)firstRow=
newRow}var cell=selectfirstCell($(firstRow))};viewBuilder.ResetTable();updateColumns();updateDataRows();$scope.InitView()};this.BuildTable=buildDecisionTableView;var removePopovers=function(){$(".popover").each(function(){$(this).remove()})};var getCurrentTerm=function(){if(!$scope.table.GlossaryLookup)return null;var col=getCurrentColumn();if(col&&col.Term&&$scope.table.GlossaryLookup)return $scope.table.GlossaryLookup.getTerm(col.Term);return null};var getCurrentColumnIndex=function(){var cell=
viewBuilder.GetCurrent();return $(cell).index()};var getCurrentColumn=function(){var index=getCurrentColumnIndex();var col=$scope.table.Columns[index];return col};var interpolate=FlexRule.Utilities.FormatString;var tempNormal="<span style='white-space: nowrap;'><span class=''>%s</span>"+" : <span class='%s'>%s</span></span>";var tempBold="<span style='white-space: nowrap;'><span class=''>%s</span>"+" : <span class='%s'><strong>%s</strong></span></span>";var tempItalic="<span style='white-space: nowrap;'><span class=''>%s</span>"+
" : <span class='%s'><i>%s</i></span></span>";var tempSelect="<select><small>%s</small></select>";$scope.getHintBody=function(){var column=getCurrentColumn();if(!column)return null;var term=getCurrentTerm();var info=[];info.push(interpolate(tempBold,["Type","txt-color-red",column.Type=="notice"?" Notice":column.Column]));info.push(interpolate(tempBold,["Column","txt-color-darken",column.Name]));if(term!=null){info.push(interpolate(tempBold,["Term","txt-color-green",term.name]));info.push(interpolate(tempBold,
["Domain","txt-color-green",term.type]))}var exp=term==null?column.Expression:term.expression;if(exp)info.push(interpolate(tempItalic,["Expression","txt-color-blue",exp]));if(term!=null&&(term.type=="Boolean"||term.type=="Options")){var ops=["<option></option>"];if(term.type=="Boolean"){ops.push("<option>true</option>");ops.push("<option>false</option>")}else if(term.options)$.each(term.options,function(){ops.push("<option>"+this+"</option>")});var optionsList=interpolate(tempSelect,[ops.join("")]);
info.push(interpolate(tempNormal,["Options","",optionsList]))}var str=info.join("<br/> ");return{content:str,handler:$scope.addValueToCell}};$scope.addValueToCell=function(value){viewBuilder.EnterValue(value)};$scope.editCell=function(cell){var tag=$(cell).prop("tagName");if(tag=="PRE"){cell=$(cell).parent();tag=$(cell).prop("tagName")}if(tag=="TD"){removePopovers();var i=viewBuilder.EditCell(cell,null,$scope.getHintBody)}};var addColumn=function(column,type){if(!column||!column.name)return undefined;
var newCond=viewBuilder.CreateNewColumn(column.name,type);viewBuilder.AppendColumn(newCond);var col=getCondition(column.name,column.expression,column.term);$scope.InitView();$scope.table.Columns.push(col);viewBuilder.PushNewColumn();$scope.InitView();return col};this.createNewCondition=function(column){if(!column||!column.name)return undefined;return addColumn(column,"Condition")};this.createNewAction=function(column){var col=addColumn(column,"Action");if(!col)return null;col.Column="Action";return col};
this.createNewNotice=function(column){var col=addColumn(column,"Action");if(!col)return null;col.Type="notice";col.Notice=column.notice;return col};var getCondition=function(name,expression,term){return{Column:"Condition",Name:name,Term:term,Expression:expression,Type:undefined,Variable:undefined}};var newRowClicked=function(){var cnt=$scope.table.Columns.length;var newRow=viewBuilder.CreateNewRow(cnt);viewBuilder.AppendRow(newRow);selectfirstCell($(newRow))};var selectfirstCell=function(newRow){if(newRow)return viewBuilder.EditCell(newRow.find("td:first"));
return null};$scope.addNewRow=function(){newRowClicked()};$scope.InitView=function(){var dtElement=$scope.dtElement;if(!dtElement)throw"Decision table element is not selected";viewBuilder.Init(dtElement,function(){removePopovers()},function(start,end){if(start==end)return;start=start-1;end=end-1;FlexRule.Utilities.ArrayMove($scope.table.Columns,start,end)})};var sig=modelBuilder.Signature.GetSignatureModel();$scope.updateScope=function(lookup){if(!modelBuilder)return null;$scope.table.Name=modelBuilder.Signature.GetRuleName();
$scope.table.ProcessAll=modelBuilder.GetProcessAll();$scope.table.Type=modelBuilder.GetTableType();$scope.table.Columns=modelBuilder.GetColumns();$scope.table.Inputs=sig.inputs;$scope.table.Outputs=sig.outputs;$scope.table.InputOutputs=sig.inputOutputs;$scope.table.GlossaryLookup=sig.glossaryLookup;return sig};return this}})(FlexRule,jQuery);
