(function(fr){fr.Editor.NaturalLanguageParser=function(config,parserConfig){function words(str){var obj={},words=str.split(";");for(var i=0;i<words.length;++i)obj[words[i]]=true;return obj}var rule_when=words("when");var rule_then=words("then");var rule_otherwise=words("otherwise");var rule_end=words("end");var paramdef=words("given;local;input;output");var keywords=words("when;then;otherwise;end");var booleanOperators=words("and;or;xor;nor");var is_isnot=words("is not;is;ge;gt;lt;le;eq;neq");var atoms=
{"null":true,"true":true,"false":true,"empty":true};this.getBooleanOperators=function(){return booleanOperators};this.is_isnot=is_isnot;fr.Editor.NaturalLanguageParser.getToken=function(cur){if(is_isnot.propertyIsEnumerable(cur))return"variable-2";if(booleanOperators.propertyIsEnumerable(cur))return"operator";if(atoms.propertyIsEnumerable(cur))return"atom";return null};var isOperatorChar=/[+\-*&%=<>!?|\/]/;function tokenBase(stream,state){var ch=stream.next();if(ch=="/"&&stream.eat("*")){state.tokenize=
tokenComment;return tokenComment(stream,state)}if(ch=="@"){stream.skipToEnd();return"meta"}if(state.isWhenEnd){state.allFalse();state.isWhenBody=true}stream.eatWhile(/[\w]/);var cur=stream.current();if(state.isInit)if(paramdef.propertyIsEnumerable(cur.trim())){state.allFalse();state.isParamKey=true;return"keyword"}else if(cur.trim()=="when"){state.allFalse();state.isWhenNoname=stream.string.trim()=="when";state.isWhenKey=true;return"keyword"}else{if(cur.trim()=="end"){state.allFalse();state.isInit=
true;return"keyword"}}else if(state.isWhenKey){var no=state.isWhenNoname;state.allFalse();cur=cur.trim();if(cur=="end"){state.allFalse();state.isInit=true;stream.backUp(cur.length);return null}else if(cur=="then"){state.allFalse();state.isThenBody=true;return"keyword"}else if(cur=="otherwise"){state.allFalse();state.isOtherwiseBody=true;return"keyword"}else{if(!no){var ch=null;while(ch=stream.peek())stream.eat(ch);state.isWhenEnd=stream.eol()}else state.isWhenEnd=true;return no?"variable":"def"}}else if(state.isWhenBody||
state.isThenBody||state.isOtherwiseBody){cur=cur.trim();if(cur=="end"){state.allFalse();state.isInit=true;stream.backUp(cur.length);return null}if(/[\[\]{}\(\),;\:\.]/.test(ch))return null;if(/\d/.test(ch)){stream.eatWhile(/[\w\.]/);return"number"}if(isOperatorChar.test(ch)){stream.eatWhile(isOperatorChar);return"operator"}if(is_isnot.propertyIsEnumerable(cur))return"variable-2";if(booleanOperators.propertyIsEnumerable(cur))return"operator";if(atoms.propertyIsEnumerable(cur))return"atom";if(cur.trim()==
"then"){state.allFalse();state.isThenBody=true;return"keyword"}else if(cur.trim()=="otherwise"){state.allFalse();state.isOtherwiseBody=true;return"keyword"}}else if(state.isParamKey){stream.skipToEnd();state.allFalse();state.isInit=true;return"variable"}if(ch=='"'||ch=="'"){state.tokenize=tokenString(ch);return state.tokenize(stream,state)}return"variable"}function tokenString(quote){return function(stream,state){var escaped=false,next,end=false;while((next=stream.next())!=null){if(next==quote&&!escaped){end=
true;break}escaped=!escaped&&next=="\\"}if(end||!escaped)state.tokenize=null;return"string"}}function tokenComment(stream,state){var maybeEnd=false,ch;while(ch=stream.next()){if(ch=="/"&&maybeEnd){state.tokenize=null;break}maybeEnd=ch=="*"}return"comment"}return{startState:function(){var sts={tokenize:null,isInit:true,isParamKey:false,isParamList:false,isParamEnd:false,isWhenNoname:false,isWhenKey:false,isWhenName:false,isWhenBody:false,isThenKey:false,isThenName:false,isThenBody:false,isOtherwiseKey:false,
isOtherwiseName:false,isOtherwiseBody:false,isWhenEnd:false};sts.allFalse=function(){this.isInit=false;this.isParamKey=false;this.isParamList=false;this.isParamEnd=false;this.isWhenNoname=false;this.isWhenKey=false;this.isWhenName=false;this.isWhenBody=false;this.isThenKey=false;this.isThenName=false;this.isThenBody=false;this.isOtherwiseKey=false;this.isOtherwiseName=false;this.isOtherwiseBody=false;this.isWhenEnd=false};return sts},token:function(stream,state){var style=(state.tokenize||tokenBase)(stream,
state);return style}}}})(FlexRule);
(function(mod){if(typeof exports=="object"&&typeof module=="object")mod(require("../../lib/codemirror"));else if(typeof define=="function"&&define.amd)define(["../../lib/codemirror"],mod);else mod(CodeMirror)})(function(CodeMirror){CodeMirror.defineMode("FlexRule-NaturalLanguage",function(config,parserConfig){var glossary=parserConfig.glossary;CodeMirror.defineDocExtension("frGlossary",glossary);var termsOverlayTokenizer={token:function(stream,state){var getQuery=function(query,caseInsensitive){var pattern=
"\\s*"+query.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+"\\s*";return new RegExp(pattern,caseInsensitive?"gi":"g")};stream.eatSpace();var line=stream.string.substring(stream.pos);if(!FlexRule.Utilities.StartsWith(stream.string.trim(),"when ")){var termsName=glossary.getAllNames();var count=FlexRule.Utilities.WordCount(line);for(var w=0;w<count;w++){var str=FlexRule.Utilities.WordGrab(line,w+1);for(var i=0;i<termsName.length;i++){var pattern=getQuery(termsName[i]);var res=pattern.exec(str);
if(res&&res.length&&res.index==0){stream.pos+=res[0].length;return"term"}}}}var nextWord=FlexRule.Utilities.WordGrab(line,1);if(nextWord.length==0)return null;stream.pos+=nextWord.length;return FlexRule.Editor.NaturalLanguageParser.getToken(nextWord)}};var termsOverlay=CodeMirror.overlayMode(CodeMirror.getMode(config,"FlexRule-NaturalLanguage-Parser"),termsOverlayTokenizer);var whenTokenizer={startState:function(){return{start:true}},token:function(stream,state){var getQuery=function(query,caseInsensitive){var pattern=
"\\s*"+query.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+"\\s*";return new RegExp(pattern,caseInsensitive?"gi":"g")};var termsName=glossary.getAllWhens();for(var i=0;i<termsName.length;i++)if(!FlexRule.Utilities.StartsWith(stream.string.trim(),"when ")&&stream.match(new RegExp(termsName[i].regex,"g"),false)){var pattern=new RegExp(termsName[i].regex,"g");var res=pattern.exec(stream.string);if(res&&res.length&&res.length>0)if(stream.pos<res.index){stream.pos=res.index;return null}else{stream.pos+=
res[0].length;return"def"}}while(stream.next()!=null);return null}};var whenOverlay=CodeMirror.overlayMode(termsOverlay,whenTokenizer);var whenParamTokenizer={token:function(stream,state){var ch;if(stream.match("{"))while((ch=stream.next())!=null)if(ch=="}")return"whenParam";while(stream.next()!=null&&!stream.match("{",false));return null}};return CodeMirror.overlayMode(whenOverlay,whenParamTokenizer)});CodeMirror.defineMode("FlexRule-NaturalLanguage-Parser",FlexRule.Editor.NaturalLanguageParser);
CodeMirror.defineMIME("text/x-flexrule-naturallanguage","flexrule-naturallanguage")});
